<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>å‡¯åœ£ç‹ç¢³å¾ªç¯ç”Ÿæˆå™¨-é˜¿äº®å¥èº«</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --primary:#0ea5e9;
  --primary-light:#38bdf8;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#f43f5e;
  --dark:#1e293b;
  --light:#f8fafc;
  --high:#bae6fd;
  --med:#e0f2fe;
  --low:#fef3c7;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
body{
  background:linear-gradient(135deg,#e0f7ff,#ffffff);
  color:#334155;
  min-height:100vh;
  padding:16px;
}
.container{max-width:1400px;margin:0 auto}
header{color:#0ea5e9;text-align:center;margin-bottom:24px}
header h1{font-size:1.8rem;margin-bottom:4px;font-weight:700}
header .subtitle{font-size:.9rem;color:#64748b}

.top-row{display:flex;gap:16px;flex-wrap:wrap}
.top-row>section{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
  flex:1 1 260px;
  min-width:260px;
}
.top-row h3{
  font-size:1rem;
  margin-bottom:10px;
  color:#0ea5e9;
  font-weight:600;
}
.basic-row,.macro-row{display:flex;gap:8px;flex-wrap:wrap}
.basic-row .input-group,.macro-row .input-group{flex:1 1 100px;display:flex;flex-direction:column}
.top-row label{font-size:.8rem;font-weight:600;margin-bottom:4px}
.top-row input,.top-row select{
  padding:6px 8px;
  font-size:.8rem;
  border:1px solid #cbd5e1;
  border-radius:6px;
}

/* æ–°å¢ï¼šé’ˆå¯¹ç›®æ ‡ä½“é‡è¾“å…¥æ¡†çš„æ ·å¼ä¼˜åŒ– */
.target-weight-input-group {
  flex: 0 1 auto !important; /* è¦†ç›–åŸæœ‰çš„flexå±æ€§ï¼Œé˜²æ­¢è¿‡åº¦æ‹‰ä¼¸ */
  min-width: unset !important;
}

.target-weight-controls {
  display: flex;
  align-items: center;
  gap: 4px;
  justify-content: center;
}

.target-weight-controls input {
  width: 50px !important; /* å›ºå®šè¾“å…¥æ¡†å®½åº¦ */
  text-align: center;
  margin: 0 2px;
}

.target-weight-controls button {
  flex: 0 0 20px;
  height:20px;
  border:1px solid var(--primary-light);
  background:#fff;
  color:var(--primary-light);
  border-radius:50%;
  font-size:14px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.body-type-cards,.plan-cards{display:flex;gap:6px;flex-wrap:wrap}
.body-type-card,.plan-card{
  flex:1 1 80px;
  border:1px solid #cbd5e1;
  border-radius:8px;
  padding:8px 4px;
  font-size:.7rem;
  text-align:center;
  cursor:pointer;
  transition:.2s;
  background:#fff;
}
.body-type-card:hover,.plan-card:hover{transform:translateY(-1px)}
.body-type-card.selected,.plan-card.selected{
  border-color:var(--primary);
  background:#e0f2fe;
}
.body-type-card h4,.plan-card h4{font-size:.75rem;margin-bottom:2px;color:#0ea5e9}
.body-type-card p,.plan-card p{font-size:.6rem;margin:0;line-height:1.2;color:#64748b}

.summary-cards{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.summary-card{
  flex:1 1 70px;
  background:#f0f9ff;
  border-radius:8px;
  padding:8px;
  text-align:center;
  font-size:.75rem;
}
.summary-card .val{font-size:1rem;font-weight:700;color:var(--primary)}
.summary-card .lab{font-size:.6rem;color:#475569}

.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
.btn-row button{
  flex:1 1 100px;
  padding:10px 0;
  border:none;
  border-radius:6px;
  font-size:.85rem;
  font-weight:600;
  cursor:pointer;
  color:#fff;
  transition:.2s;
}
.btn-calc{background:var(--primary)}
.btn-down{background:var(--success)}
.btn-reset{background:var(--warning)}
.btn-row button:hover{opacity:.9}

.table-wrap{overflow-x:auto;margin-top:16px}
table{width:100%;border-collapse:collapse;font-size:.75rem}
th,td{border:1px solid #e2e8f0;padding:6px 4px;text-align:center}
th{background:#f1f5f9;color:#0ea5e9;font-weight:600}
tbody tr:nth-child(odd){background:#fff}
tbody tr:nth-child(even){background:#f8fafc}
thead tr:nth-child(2) .high{background:var(--high);color:#0c4a6e}
thead tr:nth-child(2) .med{background:var(--med);color:#0c4a6e}
thead tr:nth-child(2) .low{background:var(--low);color:#78350f}
.editable{background:#fffbeb}

.notes{
  background:#fff;
  border-radius:12px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
  padding:16px 20px;
  margin-top:20px;
  font-size:.8rem;
  line-height:1.6;
  color:#475569;
}
.notes h3{margin-bottom:10px;color:#0ea5e9;font-size:1rem}
.notes ul{margin:0;padding-left:20px}
.notes li{margin-bottom:6px}
.notes .tag{display:inline-block;padding:2px 6px;border-radius:4px;color:#fff;font-weight:bold;margin-right:4px;font-size:.7rem}
.notes .tag.high{background:var(--high);color:#0c4a6e}
.notes .tag.med{background:var(--med);color:#0c4a6e}
.notes .tag.low{background:var(--low);color:#78350f}
footer{color:#94a3b8;text-align:center;font-size:.6rem;margin-top:20px}

.custom-plan{display:none;gap:4px;flex-wrap:wrap;margin-top:8px}
.custom-plan input{
  flex:1 1 60px;
  font-size:.7rem;
  padding:4px 2px;
  text-align:center;
  border:1px solid #cbd5e1;
  border-radius:4px;
}
.target-info{
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-top:16px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}
.target-info h3{
  font-size:1rem;
  margin-bottom:8px;
  color:#0ea5e9;
  font-weight:600;
}
.target-stats{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.target-stat{
  flex:1 1 100px;
  background:#f0f9ff;
  border-radius:8px;
  padding:8px;
  text-align:center;
}
.target-stat .value{
  font-size:1.1rem;
  font-weight:700;
  color:var(--primary);
}
.target-stat .label{
  font-size:.7rem;
  color:#64748b;
}

/* åª’ä½“æŸ¥è¯¢ï¼šé’ˆå¯¹å°å±å¹•è®¾å¤‡çš„ä¼˜åŒ– */
@media (max-width: 480px) {
  .basic-row .input-group {
    flex: 1 1 100px !important;
  }
  
  .target-weight-input-group {
    flex: 0 1 120px !important; /* åœ¨å°å±å¹•ä¸Šè¿›ä¸€æ­¥é™åˆ¶å®½åº¦ */
  }
  
  .target-weight-controls {
    justify-content: flex-start;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h2>å‡¯åœ£ç‹ç¢³å¾ªç¯æ™ºèƒ½å·¥å…·-é˜¿äº®å¥èº«</h2>
    <p class="subtitle">æ©±çª—æœ‰ç¢³å¾ªç¯å¿…å¤‡è¥å…»ç´ ï¼Œæ„Ÿè°¢å„ä½å…„å¼Ÿ</p>
  </header>

  <div class="top-row">
    <!-- åŸºç¡€ä¿¡æ¯ -->
    <section>
      <h3>ç¬¬ä¸€æ­¥ï¼šè¾“å…¥åŸºç¡€ä¿¡æ¯</h3>
      <div class="basic-row">
        <div class="input-group"><label>å½“å‰ä½“é‡(kg)</label><input type="number" id="weight" value="75" min="40" max="200"></div>
        <div class="input-group target-weight-input-group">
          <label>ç›®æ ‡ä½“é‡(Â±5kg)</label>
          <div class="target-weight-controls">
            <button type="button" onclick="adjustTarget(-1)">âˆ’</button>
            <input type="tel" id="targetWeight" value="70" min="40" max="200" step="1" pattern="\d*" oninput="clipTargetWeight()">
            <button type="button" onclick="adjustTarget(1)">+</button>
          </div>
        </div>
        <div class="input-group"><label>èº«é«˜(cm)</label><input type="number" id="height" value="178" min="140" max="220"></div>
        <div class="input-group"><label>å¹´é¾„(å²)</label><input type="number" id="age" value="30" min="18" max="80"></div>
        <div class="input-group"><label>æ€§åˆ«</label>
          <select id="gender"><option value="male">ç”·</option><option value="female">å¥³</option></select>
        </div>
      </div>
    </section>

    <!-- èƒšå‹ -->
    <section>
      <h3>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©èƒšå‹</h3>
      <div class="body-type-cards">
        <div class="body-type-card selected" data-type="ectomorph"><h4>å¤–èƒšå‹</h4><p>æ˜“ç˜¦</p></div>
        <div class="body-type-card" data-type="mesomorph"><h4>ä¸­èƒšå‹</h4><p>è‚Œè‚‰å‹</p></div>
        <div class="body-type-card" data-type="endomorph"><h4>å†…èƒšå‹</h4><p>æ˜“èƒ–</p></div>
      </div>
    </section>

    <!-- è®­ç»ƒè®¡åˆ’ -->
    <section>
      <h3>ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©è®­ç»ƒè®¡åˆ’</h3>
      <div class="plan-cards">
        <div class="plan-card selected" data-plan="1"><h4>ç»ƒ1ä¼‘1</h4><p>å¾ªç¯</p></div>
        <div class="plan-card" data-plan="2"><h4>ç»ƒ2ä¼‘1</h4><p>å¾ªç¯</p></div>
        <div class="plan-card" data-plan="3"><h4>ç»ƒ3ä¼‘1</h4><p>å¾ªç¯</p></div>
        <div class="plan-card" data-plan="4"><h4>ç»ƒ4ä¼‘1</h4><p>å¾ªç¯</p></div>
        <div class="plan-card" data-plan="custom"><h4>è‡ªå®šä¹‰</h4><p>è‡ªç”±</p></div>
      </div>
      <div class="custom-plan" id="customPlan">
        <input placeholder="å‘¨ä¸€" id="cus-mon">
        <input placeholder="å‘¨äºŒ" id="cus-tue">
        <input placeholder="å‘¨ä¸‰" id="cus-wed">
        <input placeholder="å‘¨å››" id="cus-thu">
        <input placeholder="å‘¨äº”" id="cus-fri">
        <input placeholder="å‘¨å…­" id="cus-sat">
        <input placeholder="å‘¨æ—¥" id="cus-sun">
      </div>
    </section>

    <!-- å®é‡ -->
    <section>
      <h3>è¥å…»ç´ è®¾ç½®ï¼ˆå·²æ ¹æ®èƒšå‹è‡ªåŠ¨åŒ¹é…ï¼Œæ— éœ€è°ƒæ•´ï¼‰</h3>
      <div class="macro-row">
        <div class="input-group"><label>ç¢³æ°´(g/kg)</label><input type="number" id="carbsPerKg" value="3.0" step="0.1" min="1" max="10"></div>
        <div class="input-group"><label>è›‹ç™½è´¨(g/kg)</label><input type="number" id="proteinPerKg" value="1.3" step="0.1" min="0.8" max="3"></div>
        <div class="input-group"><label>è„‚è‚ª(g/kg)</label><input type="number" id="fatPerKg" value="1.1" step="0.1" min="0.5" max="2"></div>
      </div>
    </section>

    <!-- æ±‡æ€» -->
    <section>
      <h3>æœ€åä¸€æ­¥ï¼šç‚¹å‡»ä¸‹æ–¹è®¡ç®—è®¡åˆ’</h3>
      <div class="summary-cards">
        <div class="summary-card"><span class="val" id="bmrValue">1852</span><div class="lab">åŸºç¡€ä»£è°¢</div></div>
        <div class="summary-card"><span class="val" id="tdeeValue">2352</span><div class="lab">æ¯æ—¥æ€»æ¶ˆè€—</div></div>
        <div class="summary-card"><span class="val" id="proteinValue">98</span><div class="lab">æ¯æ—¥è›‹ç™½(g)</div></div>
        <div class="summary-card"><span class="val" id="carbsValue">1575</span><div class="lab">æ¯å‘¨ç¢³æ°´(g)</div></div>
      </div>
    </section>
  </div>

  <div class="btn-row">
    <button class="btn-calc" id="calculateBtn">è®¡ç®—è®¡åˆ’</button>
    <button class="btn-down" id="downloadBtn">ä¸‹è½½Excel(ç”µè„‘ç«¯)</button>
    <button class="btn-reset" id="resetBtn">é‡ç½®</button>
  </div>

  <div class="target-info">
    <h3>ç›®æ ‡ä½“é‡åˆ†æ<br>éœ€è¦ç¢³å¾ªç¯é£Ÿè°±å¯ç§ä¿¡ä¸»åŒ…æˆ–å¾®ä¿¡(æœ‰å¿): ll8819112</h3>
    <div class="target-stats">
      <div class="target-stat">
        <div class="value" id="weightDiffValue">-5</div>
        <div class="label">ä½“é‡å·®(kg)</div>
      </div>
      <div class="target-stat">
        <div class="value" id="weeklyCalorieDiffValue">-1400</div>
        <div class="label">å‘¨çƒ­é‡å·®(kcal)</div>
      </div>
      <div class="target-stat">
        <div class="value" id="daysNeededValue">42</div>
        <div class="label">é¢„è®¡å¤©æ•°</div>
      </div>
      <div class="target-stat">
        <div class="value" id="targetDate">2023-12-24</div>
        <div class="label">é¢„è®¡å®Œæˆæ—¥æœŸ</div>
      </div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="planTable">
      <thead>
        <tr><th rowspan="2">é¡¹ç›®</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr>
        <tr id="carbLevelRow">
          <th class="med">ä¸­</th>
          <th class="high">é«˜</th>
          <th class="low">ä½</th>
          <th class="med">ä¸­</th>
          <th class="low">ä½</th>
          <th class="high">é«˜</th>
          <th class="med">ä¸­</th>
        </tr>
      </thead>
      <tbody>
        <tr class="band"><td>è®­ç»ƒéƒ¨ä½<br>(å¯åŒå‡»è‡ªå®šä¹‰)</td><td class="editable">ä¼‘æ¯</td><td class="editable">èƒŒ+äºŒå¤´</td><td class="editable">ä¼‘æ¯</td><td class="editable">èƒ¸+ä¸‰å¤´</td><td class="editable">ä¼‘æ¯</td><td class="editable">è…¿+è‚©</td><td class="editable">ä¼‘æ¯</td></tr>
        <tr class="band"><td>ç¢³æ°´(g)</td><td id="carb-mon">192</td><td id="carb-tue">412</td><td id="carb-wed">124</td><td id="carb-thu">192</td><td id="carb-fri">124</td><td id="carb-sat">412</td><td id="carb-sun">124</td></tr>
        <tr class="band"><td>è›‹ç™½è´¨(g)</td><td id="protein-mon">118</td><td id="protein-tue">118</td><td id="protein-wed">118</td><td id="protein-thu">118</td><td id="protein-fri">118</td><td id="protein-sat">118</td><td id="protein-sun">118</td></tr>
        <tr class="band"><td>è„‚è‚ª(g)</td><td id="fat-mon">64</td><td id="fat-tue">41</td><td id="fat-wed">137</td><td id="fat-thu">64</td><td id="fat-fri">137</td><td id="fat-sat">41</td><td id="fat-sun">137</td></tr>
        <tr class="band"><td>çƒ­é‡(kcal)</td><td id="cal-mon">1817</td><td id="cal-tue">2490</td><td id="cal-wed">2202</td><td id="cal-thu">1817</td><td id="cal-fri">2202</td><td id="cal-sat">2490</td><td id="cal-sun">2202</td></tr>
        <tr class="band"><td>ç¼ºå£/ç›ˆä½™</td><td id="diff-mon">-535</td><td id="diff-tue">138</td><td id="diff-wed">-150</td><td id="diff-thu">-535</td><td id="diff-fri">-150</td><td id="diff-sat">138</td><td id="diff-sun">-150</td></tr>
      </tbody>
    </table>
  </div>

  <div class="notes">
    <h3>ğŸ“Œ ç¢³å¾ªç¯è®¡åˆ’è¯´æ˜</h3>
    <ul>
      <li>å¦‚æœä½ éª¨æ¶å°ã€è‚©çª„ã€åƒä¸èƒ–ã€å¢è‚Œæ…¢ï¼š<strong>â†’ åå¤–èƒšå‹</strong></li>
      <li>å¦‚æœä½ è‚©å®½è…°çª„ã€è‚Œè‚‰å®¹æ˜“é•¿ï¼š<strong>â†’ åä¸­èƒšå‹</strong></li>
      <li>å¦‚æœä½ éª¨æ¶å¤§ã€è…°è…¹æ˜“å›¤è‚‰ï¼š<strong>â†’ åå†…èƒšå‹</strong></li>
      <li><span class="tag high">é«˜ç¢³æ—¥</span>ï¼šç¢³æ°´å å‘¨æ€»ç¢³æ°´çš„50%ï¼Œå»ºè®®æ‘„å…¥ç²¾åˆ¶ç¢³æ°´ï¼ˆå¦‚ç™½ç±³ã€ç™½é¢åŒ…ï¼‰</li>
      <li><span class="tag med">ä¸­ç¢³æ—¥</span>ï¼šç¢³æ°´å å‘¨æ€»ç¢³æ°´çš„35%ï¼Œå»ºè®®æ··åˆç²¾ç¢³å’Œç²—ç¢³</li>
      <li><span class="tag low">ä½ç¢³æ—¥</span>ï¼šç¢³æ°´å å‘¨æ€»ç¢³æ°´çš„15%ï¼Œå»ºè®®æ‘„å…¥ç²—ç¢³ï¼ˆå¦‚ç³™ç±³ã€ç‡•éº¦ï¼‰</li>
      <li><strong>çƒ­é‡æ¢ç®—ï¼š</strong> ç¢³/è›‹ç™½ 4 kcal/gï¼Œè„‚è‚ª 9 kcal/gã€‚</li>
      <li><strong>ä½“é‡å˜åŒ–ä¼°ç®—ï¼š</strong> æ¯å‡å°‘7700 kcalçƒ­é‡çº¦å‡å°‘1 kgä½“é‡ï¼Œæ¯å¢åŠ 7700 kcalçƒ­é‡çº¦å¢åŠ 1 kgä½“é‡ã€‚</li>
    </ul>
  </div>
  <footer>ç¢³å¾ªç¯è®¡åˆ’è¡¨ç”Ÿæˆå™¨Â© 2025 Â· é˜¿äº®å¥èº«(å‡¯é—¨)</footer>
</div>

<script>
/* ---------- å·¥å…· ---------- */
const $ = id => document.getElementById(id)

/* ---------- èƒšå‹ ---------- */
const bodyCards = [...document.querySelectorAll('.body-type-card')]
bodyCards.forEach(c => c.addEventListener('click', () => {
  bodyCards.forEach(x => x.classList.remove('selected'))
  c.classList.add('selected')
  setMacros(c.dataset.type)
}))
function setMacros(type){
  const map = {ectomorph:{c:3,p:1.3,f:1.1},mesomorph:{c:2.5,p:1.3,f:0.9},endomorph:{c:2,p:1.3,f:0.8}}
  $('carbsPerKg').value = map[type].c
  $('proteinPerKg').value = map[type].p
  $('fatPerKg').value = map[type].f
  calc()
}

/* ---------- æ˜¾ç¤º/éšè—è‡ªå®šä¹‰è¾“å…¥ ---------- */
const planCards = [...document.querySelectorAll('.plan-card')]
const customDiv = $('customPlan')
planCards.forEach(c => c.addEventListener('click', () => {
  planCards.forEach(x => x.classList.remove('selected'))
  c.classList.add('selected')
  customDiv.style.display = c.dataset.plan === 'custom' ? 'flex' : 'none'
  calc()
}))

/* ---------- è®­ç»ƒéƒ¨ä½ç”Ÿæˆ ---------- */
function buildParts(plan){
  switch(plan){
    case '1': return ['ä¼‘æ¯','èƒŒ+äºŒå¤´','ä¼‘æ¯','èƒ¸+ä¸‰å¤´','ä¼‘æ¯','è…¿+è‚©','ä¼‘æ¯']
    case '2': return ['èƒŒ+äºŒå¤´','èƒ¸+ä¸‰å¤´','ä¼‘æ¯','è…¿+è‚©','èƒŒ+äºŒå¤´','ä¼‘æ¯','èƒ¸+ä¸‰å¤´']
    case '3': return ['èƒŒ+äºŒå¤´','èƒ¸+ä¸‰å¤´','è…¿+è‚©','ä¼‘æ¯','èƒŒ+äºŒå¤´','èƒ¸+ä¸‰å¤´','è…¿+è‚©']
    case '4': return ['èƒ¸+ä¸‰å¤´','èƒŒ+äºŒå¤´','è…¿+è‚©','èƒ¸+ä¸‰å¤´','ä¼‘æ¯','èƒŒ+äºŒå¤´','èƒ¸+ä¸‰å¤´']
    case 'custom':
      return ['mon','tue','wed','thu','fri','sat','sun'].map(d=>$(`cus-${d}`).value.trim()||'ä¼‘æ¯')
  }
}

/* ---------- ç¢³æ°´å¹³æ˜ å°„ç”Ÿæˆï¼ˆæ ¹æ®è®­ç»ƒè®¡åˆ’ï¼‰ ---------- */
function buildCarbMap(plan, parts) {
  const isRestDay = parts.map(part => part === 'ä¼‘æ¯');
  const trainingDays = [];
  const restDays = [];
  isRestDay.forEach((isRest, index) => {
    if (isRest) restDays.push(index);
    else trainingDays.push(index);
  });
  const carbPatterns = [
    ['é«˜','ä¸­','ä½','é«˜','ä¸­','ä½','ä¸­'],
    ['é«˜','ä½','ä¸­','é«˜','ä½','ä¸­','ä¸­'],
    ['ä¸­','é«˜','ä½','ä¸­','é«˜','ä½','ä¸­'],
    ['ä¸­','ä½','é«˜','ä¸­','ä½','é«˜','ä¸­'],
    ['ä½','é«˜','ä¸­','ä½','é«˜','ä¸­','ä¸­'],
    ['ä½','ä¸­','é«˜','ä½','ä¸­','é«˜','ä¸­'],
    ['ä¸­','ä¸­','é«˜','ä½','ä¸­','é«˜','ä½']
  ];
  const validPatterns = carbPatterns.filter(pattern => {
    const highCount = pattern.filter(level => level === 'é«˜').length;
    if (highCount !== 2) return false;
    const medCount = pattern.filter(level => level === 'ä¸­').length;
    if (medCount !== 3) return false;
    const lowCount = pattern.filter(level => level === 'ä½').length;
    if (lowCount !== 2) return false;
    for (let i = 0; i < 7; i++) {
      if (pattern[i] === 'é«˜' && isRestDay[i]) return false;
    }
    return true;
  });
  if (validPatterns.length === 0) {
    const defaultPattern = ['ä¸­','é«˜','ä½','ä¸­','ä½','é«˜','ä¸­'];
    for (let i = 0; i < 7; i++) {
      if (defaultPattern[i] === 'é«˜' && isRestDay[i]) {
        for (let j = 0; j < 7; j++) {
          if (!isRestDay[j] && defaultPattern[j] !== 'é«˜') {
            const temp = defaultPattern[j];
            defaultPattern[j] = defaultPattern[i];
            defaultPattern[i] = temp;
            break;
          }
        }
      }
    }
    return defaultPattern;
  }
  return validPatterns[Math.floor(Math.random() * validPatterns.length)];
}

/* ---------- ä¸»è®¡ç®— ---------- */
function calc(){
  const w=+$('weight').value,h=+$('height').value,a=+$('age').value,g=$('gender').value
  const targetW = +$('targetWeight').value
  if(!w||!h||!a||!targetW){alert('è¯·è¡¥å…¨ä¿¡æ¯');return}
  const cp=+$('carbsPerKg').value,pp=+$('proteinPerKg').value,fp=+$('fatPerKg').value
  const plan=document.querySelector('.plan-card.selected').dataset.plan

  const bmr=g==='male'?10*w+6.25*h-5*a+5:10*w+6.25*h-5*a-161
  const tdee=bmr+500
  const pro=Math.round(pp*targetW)
  const weekC=Math.round(cp*targetW*7)
  const weekF=Math.round(fp*targetW*7)
  const hc=Math.round(weekC*.5/2)
  const mc=Math.round(weekC*.35/3)
  const lc=Math.round(weekC*.15/2)
  const hf=Math.round(weekF*.15/2)
  const mf=Math.round(weekF*.35/3)
  const lf=Math.round(weekF*.50/2)

  $('bmrValue').textContent=Math.round(bmr)
  $('tdeeValue').textContent=Math.round(tdee)
  $('proteinValue').textContent=pro
  $('carbsValue').textContent=weekC

  const parts=buildParts(plan)
  const carbMap=buildCarbMap(plan, parts)
  const dayKeys=['mon','tue','wed','thu','fri','sat','sun']
  const carbNum=dayKeys.map((_,i)=>{
    switch(carbMap[i]){
      case 'é«˜':return hc
      case 'ä¸­':return mc
      case 'ä½':return lc
    }
  })
  const fats=dayKeys.map((_,i)=>{
    switch(carbMap[i]){
      case 'é«˜':return hf
      case 'ä¸­':return mf
      case 'ä½':return lf
    }
  })

  const trParts=document.querySelector('#planTable tbody tr:nth-child(1)')
  const trLevel=document.querySelector('#carbLevelRow')
  parts.forEach((p,i)=>{
    trParts.children[i+1].textContent=p
    trLevel.children[i].className=carbMap[i]==='é«˜'?'high':(carbMap[i]==='ä¸­'?'med':'low')
    trLevel.children[i].textContent=carbMap[i]
  })

  const dailyDiffs=[]
  dayKeys.forEach((d,i)=>{
    $(`carb-${d}`).textContent=carbNum[i]
    $(`protein-${d}`).textContent=pro
    $(`fat-${d}`).textContent=fats[i]
    const cal=carbNum[i]*4+pro*4+fats[i]*9
    $(`cal-${d}`).textContent=cal
    const diff=Math.round(cal - tdee)
    dailyDiffs.push(diff)
    $(`diff-${d}`).innerHTML=`<span style="color:${diff>0?(diff>300?'#10b981':'#f59e0b'):'#f43f5e'}">${diff>0?'+':''}${diff}</span>`
  })

  const weightDiff = targetW - w
  const weeklyCalorieDiff = dailyDiffs.reduce((sum, diff) => sum + diff, 0)
  let daysNeeded = 0
  let targetDateText = ''
  if (weightDiff > 0 && weeklyCalorieDiff < 0) {
    targetDateText = 'æ— æ³•å®Œæˆï¼Œè¯·å¢åŠ ç¢³æ°´'
  } else if (weightDiff < 0 && weeklyCalorieDiff > 0) {
    targetDateText = 'æ— æ³•å®Œæˆï¼Œè¯·å‡å°‘ç¢³æ°´'
  } else if (weeklyCalorieDiff === 0) {
    targetDateText = 'çƒ­é‡å¹³è¡¡ï¼Œè¯·è°ƒæ•´è®¡åˆ’'
  } else {
    daysNeeded = Math.abs(Math.round((weightDiff * 7700) / (weeklyCalorieDiff / 7)))
    const today = new Date()
    const targetDate = new Date(today)
    targetDate.setDate(today.getDate() + daysNeeded)
    targetDateText = targetDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })
  }
  $('weightDiffValue').textContent = weightDiff > 0 ? `+${weightDiff}` : weightDiff
  $('weightDiffValue').style.color = weightDiff > 0 ? '#10b981' : (weightDiff < 0 ? '#f43f5e' : '#334155')
  $('weeklyCalorieDiffValue').textContent = weeklyCalorieDiff > 0 ? `+${weeklyCalorieDiff}` : weeklyCalorieDiff
  $('weeklyCalorieDiffValue').style.color = weeklyCalorieDiff > 0 ? '#10b981' : (weeklyCalorieDiff < 0 ? '#f43f5e' : '#334155')
  $('daysNeededValue').textContent = daysNeeded || 'â€”'
  $('targetDate').textContent = targetDateText
}

/* ---------- å¯¼å‡º & é‡ç½® ---------- */
function dl() {
  const w   = +$('weight').value;
  const tgt = +$('targetWeight').value;
  const h   = +$('height').value;
  const a   = +$('age').value;
  const g   = $('gender').value === 'male' ? 'ç”·' : 'å¥³';
  const bmr = +$('bmrValue').textContent;
  const tdee= +$('tdeeValue').textContent;
  const pro = +$('proteinValue').textContent;
  const weekCarb = +$('carbsValue').textContent;
  const weightDiff  = +$('weightDiffValue').textContent;
  const weekDiffKcal= +$('weeklyCalorieDiffValue').textContent;
  const daysNeed    = $('daysNeededValue').textContent;
  const finishDate  = $('targetDate').textContent;

  const basicRows = [
    ['åŸºç¡€ä¿¡æ¯','','','','','','',''],
    ['å½“å‰ä½“é‡(kg)', w,'','','','','',''],
    ['ç›®æ ‡ä½“é‡(kg)', tgt,'','','','','',''],
    ['èº«é«˜(cm)', h,'','','','','',''],
    ['å¹´é¾„(å²)', a,'','','','','',''],
    ['æ€§åˆ«', g,'','','','','',''],
    ['åŸºç¡€ä»£è°¢(kcal)', bmr,'','','','','',''],
    ['æ¯æ—¥æ€»æ¶ˆè€—(kcal)', tdee,'','','','','',''],
    ['æ¯æ—¥è›‹ç™½(g)', pro,'','','','','',''],
    ['æ¯å‘¨ç¢³æ°´(g)', weekCarb,'','','','','',''],
    ['','','','','','','',''],
    ['ç›®æ ‡åˆ†æ','','','','','','',''],
    ['ä½“é‡å·®(kg)', weightDiff,'','','','','',''],
    ['å‘¨çƒ­é‡å·®(kcal)', weekDiffKcal,'','','','','',''],
    ['é¢„è®¡å¤©æ•°', daysNeed,'','','','','',''],
    ['é¢„è®¡å®Œæˆæ—¥æœŸ', finishDate,'','','','','',''],
    ['','','','','','','','']
  ];

  const thead = ['é¡¹ç›®','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
  const planRows = [thead];
  const parts = Array.from(document.querySelectorAll('#planTable tbody tr:nth-child(1) td')).slice(1).map(td=>td.textContent);
  planRows.push(['è®­ç»ƒéƒ¨ä½', ...parts]);
  const levels = Array.from(document.querySelectorAll('#carbLevelRow th')).map(th=>th.textContent);
  planRows.push(['ç¢³æ°´å¹³', ...levels]);
  const labels = ['ç¢³æ°´(g)','è›‹ç™½è´¨(g)','è„‚è‚ª(g)','çƒ­é‡(kcal)','ç¼ºå£/ç›ˆä½™(kcal)'];
  [2,3,4,5,6].forEach(i=>{
    const tds = Array.from(document.querySelectorAll(`#planTable tbody tr:nth-child(${i}) td`)).slice(1);
    planRows.push([labels[i-2], ...tds.map(td=>td.textContent)]);
  });

  const fullData = [...basicRows, ...planRows];
  const ws = XLSX.utils.aoa_to_sheet(fullData);
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = 0; R <= range.e.r; R++) {
    for (let C = range.s.c; C <= range.e.c; C++) {
      const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
      if (!cell) continue;
      cell.s = cell.s || {};
      if (R < basicRows.length && C === 0) { cell.s.font = {bold:true}; }
      if (R === basicRows.length + 1) {
        cell.s.font = {bold:true, color:{rgb:"FFFFFF"}};
        cell.s.fill = {fgColor:{rgb:"0284c7"}, patternType:"solid"};
      }
    }
  }
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ç¢³å¾ªç¯å®Œæ•´è®¡åˆ’');
  XLSX.writeFile(wb, `ç¢³å¾ªç¯_${w}kg.xlsx`);
}
function reset(){
  $('weight').value=75;
  $('targetWeight').value=70;
  $('height').value=178;
  $('age').value=30;
  $('gender').value='male'
  bodyCards[0].click()
  planCards[0].click()
  ;['mon','tue','wed','thu','fri','sat','sun'].forEach(d=>$(`cus-${d}`).value='')
}
function clipTargetWeight(){
  const w   = +$('weight').value;
  const tgt = $('targetWeight');
  let v = +tgt.value;
  v = Math.min(Math.max(v, w - 5), w + 5);
  if(v !== +tgt.value) tgt.value = v;
}
function adjustTarget(delta){
  const el = $('targetWeight');
  let v = +el.value + delta;
  const w = +$('weight').value;
  v = Math.min(Math.max(v, w - 5), w + 5);
  el.value = v;
  clipTargetWeight();
}

/* ---------- äº‹ä»¶ ---------- */
$('calculateBtn').addEventListener('click',calc)
$('downloadBtn').addEventListener('click',dl)
$('resetBtn').addEventListener('click',reset)
document.querySelectorAll('.editable').forEach(cell=>{
  cell.addEventListener('dblclick',()=>{
    const v=cell.textContent
    cell.innerHTML=`<input value="${v}" style="width:100%;font-size:.7rem">`
    const inp=cell.querySelector('input')
    inp.focus()
    inp.onblur=inp.onkeydown=e=>{
      if(e.type==='blur'||e.key==='Enter'){cell.textContent=inp.value||v}
    }
  })
})

/* ---------- åˆå§‹åŒ– ---------- */
setMacros('ectomorph')
calc();
clipTargetWeight();
</script>
</body>
</html>
